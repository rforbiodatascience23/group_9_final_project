### Library

```{r}
#| eval: true
#| echo: true

library("tidyverse")
```

### Loading

```{r}
#| eval: true
#| echo: true

# load tsv files
ncbi_clean_pheno <- read_tsv("../data/02_ncbi_clean_pheno.tsv.gz")
ncbi_clean_expr <- read_tsv("../data/02_ncbi_clean_expression.tsv.gz")
ncbi_joined <- vroom::vroom("../data/04_ncbi_joined.tsv.gz", delim = "\t")

```

### BMI class and Age group augmenation:

```{r}
#| eval: true
#| echo: true

ncbi_augment_pheno <- ncbi_clean_pheno |>
  drop_na(maternal_bmi) |>
  mutate(BMI_class = case_when(maternal_bmi < 16.5 ~ "Severely underweight",
                               16.5 <= maternal_bmi & maternal_bmi < 18.5 ~ "Underweight",
                               18.5 <= maternal_bmi & maternal_bmi < 24.9 ~ "Normal weight",
                               24.9 <= maternal_bmi & maternal_bmi < 30 ~ "Overweight",
                               maternal_bmi >= 30 & maternal_bmi < 35 ~ "Obesity class I",
                               maternal_bmi >= 35 & maternal_bmi < 40 ~ "Obesity class II",
                               maternal_bmi >= 40 ~ "Obesity class III")) |>
  mutate(BMI_class = factor(BMI_class,
                            levels = c("Severely underweight",
                                       "Underweight",
                                       "Normal weight", 
                                       "Overweight",
                                       "Obesity", 
                                       "Obesity class I",
                                       "Obesity class II", 
                                       "Obesity class III"))) |>
  relocate(BMI_class,
           .before = maternal_bmi) |>
  select(-maternal_bmi) |>
  mutate(age_group = cut(age,
                         breaks = c(20,
                                    30,
                                    40,
                                    50,
                                    60,
                                    70,
                                    80))) |>
  relocate(age_group,
           .before = age) |>
  select(-age)
```

```{r}

gene_exp_cord <- ncbi_joined |> 
  mutate(sample_source = str_match(title, "[[:upper:]]+")) |>
  filter(sample_source == "D") |> 
  select(smoking_status, "JMJD1A":"KRTAP19-1")

# calculate mean expressions of genes for both statuses of smoking
mean_expr_nonsmoker <- gene_exp_cord |>
  filter(smoking_status == "non-smoker") |> 
  select(-1) |> 
  colMeans()
mean_expr_smoker <- gene_exp_cord |>
  filter(smoking_status == "smoker") |> 
  select(-1) |> 
  colMeans()

# calculate log fold change
smoking_fc_cord <-
  tibble(mean_expr_nonsmoker, 
         mean_expr_smoker) |>  
  mutate(Gene = names(mean_expr_nonsmoker)) |> 
  relocate(Gene) |> 
  mutate(log2fc = log2(mean_expr_smoker) - log2(mean_expression_nonsmoker))
```

### Write tsv file

```{r}
#| eval: true
#| echo: true

write_tsv(x = ncbi_augment_pheno,
          file = "../data/04_ncbi_augment_pheno.tsv.gz")

write_tsv(x = ncbi_joined_aug,
          file = "../data/04_ncbi_joined_aug.tsv.gz")

write_tsv(x = smoking_fc_cord,
          file = "../data/04_ncbi_smoking_logfc_cord_blood.tsv.gz")
```
