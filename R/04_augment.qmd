### Library

```{r}
#| eval: true
#| echo: true

library("tidyverse")
```

### Source functions

```{r}
source("../R/99_proj_func.R")
```

### Loading

```{r}
#| eval: true
#| echo: true

# load tsv files
ncbi_clean_pheno <- read_tsv("../data/02_ncbi_clean_pheno.tsv.gz")
ncbi_clean_expr <- read_tsv("../data/02_ncbi_clean_expression.tsv.gz")
ncbi_joined <- vroom::vroom("../data/04_ncbi_joined.tsv.gz", delim = "\t")

```

### BMI class and Age group augmenation:

```{r}
#| eval: true
#| echo: true

ncbi_augment_pheno <- ncbi_clean_pheno |>
  drop_na(maternal_bmi) |>
  mutate(BMI_class = case_when(maternal_bmi < 16.5 ~ "Severely underweight",
                               16.5 <= maternal_bmi & maternal_bmi < 18.5 ~ "Underweight",
                               18.5 <= maternal_bmi & maternal_bmi < 24.9 ~ "Normal weight",
                               24.9 <= maternal_bmi & maternal_bmi < 30 ~ "Overweight",
                               maternal_bmi >= 30 & maternal_bmi < 35 ~ "Obesity class I",
                               maternal_bmi >= 35 & maternal_bmi < 40 ~ "Obesity class II",
                               maternal_bmi >= 40 ~ "Obesity class III")) |>
  mutate(BMI_class = factor(BMI_class,
                            levels = c("Severely underweight",
                                       "Underweight",
                                       "Normal weight", 
                                       "Overweight",
                                       "Obesity", 
                                       "Obesity class I",
                                       "Obesity class II", 
                                       "Obesity class III"))) |>
  relocate(BMI_class,
           .before = maternal_bmi) |>
  select(-maternal_bmi) |>
  mutate(age_group = cut(age,
                         breaks = c(20,
                                    30,
                                    40,
                                    50,
                                    60,
                                    70,
                                    80))) |>
  relocate(age_group,
           .before = age) |>
  select(-age)
```

### Add gene fold change for cord blood samples

```{r}

gene_exp_cord <- get_gene_expr_by_sample(ncbi_joined, "cord blood", c("smoking_status"))

# calculate mean expressions of genes for both statuses of smoking
# and calculate log fold change

gene_exp_cord_mean <- gene_exp_cord |>
  group_by(smoking_status) |> 
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE))) |> 
  pivot_longer(cols = -smoking_status, names_to = 'Gene') |> 
  pivot_wider(names_from = smoking_status, values_from = value)

smoking_fc_cord <- gene_exp_cord_mean |> 
  rename(nonsmoker = `non-smoker`) |> 
  mutate(log_fold_change = log2(smoker) - log2(nonsmoker))

smoking_fc_cord |>
  arrange(desc(abs(log_fold_change))) |> 
  slice_head(n=5)
```

### Joining:

```{r}
ncbi_joined_aug <- ncbi_augment_pheno |>
  full_join(ncbi_clean_expr)
```

### Write tsv file

```{r}
#| eval: true
#| echo: true

write_tsv(x = ncbi_augment_pheno,
          file = "../data/04_ncbi_augment_pheno.tsv.gz")

write_tsv(x = ncbi_joined_aug,
          file = "../data/04_ncbi_joined_aug.tsv.gz")

write_tsv(x = smoking_fc_cord,
          file = "../data/04_ncbi_smoking_logfc_cord_blood.tsv.gz")
```
