### Source functions

```{r}
source("../R/99_proj_func.R")
```

### Library:

```{r}
#| eval: false 
#| echo: true
#| message: false
library("tidyverse")
library("ggridges")
library("viridis")
library("broom")
library("ggrepel")
```

### loading:

```{r}
#| eval: true
#| echo: true
#| message: false

pheno_data <- vroom::vroom("../data/04_ncbi_augment_pheno.tsv.gz",
                           delim = "\t")

# we haven't augmented expr (Masha)
# expr_data <- vroom::vroom("../data/04_ncbi_augment_expr.tsv.gz", delim = "\t")

ncbi_joined <- vroom::vroom("../data/04_ncbi_joined.tsv.gz",
                             delim = "\t")
ncbi_joined_aug <- vroom::vroom("../data/04_ncbi_joined_aug.tsv.gz",
                                 delim = "\t")
pheno_data |> 
  sample_n(5)
ncbi_joined |> 
  sample_n(5)
ncbi_joined_aug |> 
  sample_n(5)
```


### plotting:

```{r}
#| eval: false 
#| echo: true

## Magnus

# SKRALD
# SKRALD
# SKRALD

ggplot(data = ncbi_joined_aug,
       mapping = aes(x = newborn_weight,
                     y = log2(cotinine_conc_maternal))) +
  geom_point(aes(color = age_group,
                 size = factor(BMI_class,
                               levels = c("Severely underweight",
                                          "Underweight",
                                          "Normal weight", 
                                          "Overweight",
                                          "Obesity", 
                                          "Obesity class I",
                                          "Obesity class II", 
                                          "Obesity class III")))) + 
  labs(title = "Comparision of smoking severity and newborn weight",
       x = "Newborn Weight (g)",
       y = "Log2 of cotinine_conc_maternal",
       color = "Age Group",
       size = "BMI class",
       caption = "Data from NCBI (2011)") +
  theme_minimal(base_family = "Avenir") + 
  theme(legend.position = "right") 

# GULD
# GULD
# GULD
ggplot(data = ncbi_joined_aug,
       mapping = aes(x = smoking_status,
                     y = newborn_weight,
                     fill = smoking_status)) +
  geom_boxplot() +
  labs(title = "Investigating Effect of Smoking on Newborn",
       subtitle = "Comparision of newborn weight and smoking status",
       x = "",
       fill = "",
       y = "Newborn Weight (g)",
       caption = "Data from NCBI (2011)") +
  theme_minimal(base_family = "Avenir") + 
  theme(legend.position = "none") 


# GULD
# GULD 
# GULD
ggplot(data = ncbi_joined_aug,
       mapping = aes(x = newborn_weight,
                     y = placental_weight)) +
  geom_point(aes(color = smoking_status,
                 size = factor(BMI_class,
                               levels = c("Severely underweight",
                                          "Underweight",
                                          "Normal weight", 
                                          "Overweight",
                                          "Obesity", 
                                          "Obesity class I",
                                          "Obesity class II", 
                                          "Obesity class III")))) + 
  geom_hline(aes(yintercept = mean(placental_weight)),
             alpha = 0.4,
             linetype="dashed",
             color = "purple", 
             size=0.5) +
  geom_vline(aes(xintercept = mean(newborn_weight)),
             alpha = 0.4,
             linetype="dashed",
             color = "purple", 
             size=0.5) +
  labs(title = "Weight comparison",
       subtitle = "Measured in grams",
       x = "Newborn",
       y = "Placental",
       color = "Smoking Status",
       size = "BMI class",
       caption = "Data from NCBI (2011)") +
  theme_minimal(base_family = "Avenir") + 
  theme(legend.position = "right",
        legend.direction = "vertical") 

### 
###
ggplot(data = silvia_targets,
       mapping = aes(x = ???,
                     y = silvia targets,
                     fill = silvia targets)) +
  geom_density_ridges(alpha = 0.5) +
  scale_full_viridis_d() +
  labs(x = "???",
       y = "silvia targets",
       title = "bla title",
       subtitle = "bla subtitle",
       caption = "Data from NCBI (2011)") +
  theme_minimal(base_family = "Avenir",
                base_size = 10) +
  theme(legend.position = "bottom") +
  facet_wrap(vars(smoking status),
             ncol = 2)

```
# SILIVA
```{r}

```



### To be PCA
```{r}
pca_fit <- ncbi_joined_aug |>
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)

pca_fit_augment <- pca_fit |> 
  augment(ncbi_joined_aug)

pca_fit_augment  |> 
  ggplot(aes(x=.fittedPC1, 
             y=.fittedPC2)) + 
  geom_point() +
  theme_bw() +
  geom_hline(yintercept = 0) + 
  geom_vline(xintercept = 0)

summary()

```{r}
# Fitting
pca_fit <- ncbi_joined_aug |>
  select(where(is.numeric)) |>
  prcomp(scale = TRUE)

# Adding PCA data to joined augmented data frame
pca_fit_augment <- pca_fit |> 
  augment(ncbi_joined_aug)
```
```


```{r}
# Plot PC1 vs PC2
pca_fit_augment  |> 
  ggplot(aes(x=.fittedPC1, 
             y=.fittedPC2,
             color = tissue)) + 
  geom_point() +
  theme_minimal() +
  labs(x = "PC1",
       y = "PC2",
       color = "Tissue",
       title = "Scatter plot of fitted PC1 and PC2") +
  scale_colour_brewer(palette="Set1") +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed")

#ggsave("../results/plots/scatter_pc1_pc2.png", 
#       plot = scatter_pc1_pc2)
#show(scatter_pc1_pc2)
```
```{r}
# Plot PC2 vs PC3
pca_fit_augment  |> 
  ggplot(aes(x=.fittedPC2, 
             y=.fittedPC3,
             color = tissue)) + 
  geom_point() +
  theme_minimal() +
  labs(x = "PC2",
       y = "PC3",
       color = "Tissue",
       title = "Scatter plot of fitted PC2 and PC3") +
  scale_colour_brewer(palette = "Set1") +
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_vline(xintercept = 0, linetype = "dashed")

#ggsave("../results/plots/scatter_pc1_pc2.png", 
#       plot = scatter_pc1_pc2)
#show(scatter_pc1_pc2)
```
```{r}
pca_fit_rotation <- pca_fit |> 
  tidy(matrix = "rotation") |> 
  pivot_wider(names_from = "PC",
              names_prefix = "PC",
              values_from = "value")

ggplot(pca_fit_rotation,
       mapping = aes(x = PC1,
                     y = PC2)) +
  geom_segment(xend = 0, yend = 0, arrow = arrow()) +
  geom_label(
    mapping = aes(label = column),
    hjust = 1, 
    color = "royalblue", size = 2
  ) +
  labs(
    title = "Rotation matrix"
  ) +
  theme_minimal()

```
