---
title: "Clean data"
format: html
editor: source
author: authors
---

### Source functions

```{r}
source("../R/99_proj_func.R")
```

### Libraries:

```{r}
#| message: false
library("tidyverse")
library(vroom)
```

### Clean

```{r}

feature_data <- vroom("../data/01_feature_data.tsv.gz", delim = "\t")
pheno_data <- vroom("../data/01_pheno_data.tsv.gz", delim = "\t")
norm_exprs <- vroom("../data/01_norm_exprs.tsv.gz", delim = "\t")

ncbi_data <- read.table("../data/01_ncbi_pheno_data.txt", header=FALSE, fill = TRUE)

ncbi_annot_probes <- read.table("../data/01_ncbi_annot_probes.txt")
ncbi_annot_control <- read.table("../data/01_ncbi_annot_controls.txt")
```

```{r}

feature_data |> sample_n(5)
pheno_data |> sample_n(5)
norm_exprs |> sample_n(5)
ncbi_data |> sample(5)

```

### Phenotypic clean file stuff

```{r}
clean_pheno_data <- pheno_data |>
  rename("sample_id" = "geo_accession") |>
  rename(
    "Mother_age_years" = "age..years..ch1",
    "apgar_score" = "apgar.score..5s..ch1",
    "cord_blood_cotinine_ng_ml" = "cord.blood.cotinine..ng.ml..ch1",
    "gestational_age_weeks" = "gestational.age..weeks..ch1",
    "maternal_blood_cotinine_ng_ml" ="maternal.blood.cotinine..ng.ml..ch1",
    "maternal_bmi" = "maternal.bmi.ch1",
    "smoking_status" = "smoking.status.ch1",
    "newborn_weight_g"="newborn.weight..g..ch1") |>
  select("sample_id",
         "Mother_age_years",
         "apgar_score",
         "cord_blood_cotinine_ng_ml",
         "gestational_age_weeks",
         "maternal_blood_cotinine_ng_ml",
         "maternal_bmi",
         "smoking_status",
         "newborn_weight_g",
         "sex",
         "description")
```

### Raw phenotype extraction from NCBI (Masha, Einstein & Magnus)

```{r}
## Magnus
#Choose relevant data
ncbi_dirty_pheno <- ncbi_pheno_data |> 
  as_tibble() |>
  filter(!str_detect(col_1, 
                     "ILMN")) |>
  filter(!str_detect(col_1, 
                     "ID_REF")) |>
  slice(41:n()) |>
  t()
#Rename coloums
colnames(ncbi_dirty_pheno) <- ncbi_dirty_pheno[1, ] |> 
  stringr::str_replace_all("!Sample_","")

#Add colnames to 
ncbi_dirty_pheno <- ncbi_dirty_pheno[-1, ] |> 
  as_tibble() |>
  rename_with(tolower, 
              .cols = everything()) 

colnames(ncbi_dirty_pheno)

# more data wrangling
ncbi_clean_pheno <- ncbi_dirty_pheno |>
  # Choose important coloums to further wrangle. 
  select(matches(
    "geo_accession|title|characteristics_ch1|v11|v12|v13|v14|v15|v16|v17|v18|v19|v20|v21|v22")
    ) |>
  # mutate coloumn name and variable string
  mutate(
    smoking_status = str_remove(
      v11, "smoking status: "),
    tissue = str_remove(characteristics_ch1, "tissue: "),
    age = as.numeric(str_remove(
      v12, "age \\(years\\): ")),
    maternal_bmi = as.numeric(str_remove(
      v13, "maternal bmi: ")),
    parity = str_remove(v14, "parity: "),
    gestational_age = as.numeric(str_remove(
      v15, "gestational age \\(weeks\\): ")),
    birth_type = str_remove(
      v16, "mode of delivery: "),
    placental_weight = as.numeric(str_remove(
      v17, "placental weight \\(g\\): ")),
    newborn_weight = as.numeric(str_remove(
      v18, "newborn weight \\(g\\): ")),
    apgar_score = as.numeric(str_remove(
      v19, "apgar score \\(5s\\): ")),
    cotinine_conc_maternal = as.numeric(str_remove(
      v20, "maternal blood cotinine \\(ng/ml\\): ")),
    cotinine_conc_cord = as.numeric(str_remove(
      v21, "cord blood cotinine \\(ng/ml\\): ")),
    individual = str_remove(
      v22, "individual: ")) |>
  # Keep new columns
  select(-matches("characteristics_ch1|v11|v12|v13|v14|v15|v16|v17|v18|v19|v20|v21|v22")
         ) |>
  t() |> 
  as.data.frame() |>
  rename_with(~str_replace_all(., "V", "patient"), .cols = everything())

######################
ncbi_dirty_data <- ncbi_pheno_data[88:nrow(ncbi_pheno_data), , 
                                   drop = FALSE]
colnames(ncbi_dirty_data) <- ncbi_dirty_data[1, ] |>
  stringr::str_replace_all("!","")
ncbi_dirty_data <- ncbi_dirty_data[-1, ]
View(ncbi_dirty_data)
## Oliver

#Firstly chosing the right rows and transposing
ncbi_pheno_data_impure <- ncbi_pheno_data[1:86,] |> t()

#Then choosing the right columns and making as tibble
ncbi_pheno_data_impure_cut <- ncbi_pheno_data_impure[,41:86] |> as_tibble()


#Removing ! from the names and Convert first row to header
colnames(ncbi_pheno_data_impure_cut) <- ncbi_pheno_data_impure_cut[1, ] |>
  stringr::str_replace_all("!", "")

ncbi_pheno_data_impure_cut_renamed



ncbi_pheno_data_impure_cut |> View()
is.data.frame(ncbi_pheno_data_impure_cut) 


```

### Extract and normalize gene expression

```{r}

# boxplot(norm_exprs[, 2:10])
# boxplot(ncbi_pheno_data[89:100, 2:6] |> mutate_all(as.numeric))

ncbi_exp <- ncbi_data |> 
  slice(89:24615) |> 
  select(-1) |> 
  mutate_all(as.numeric)

ncbi_norm_exp <- as.tibble(quantile_normalisation(ncbi_exp))

colnames(ncbi_norm_exp) <- ncbi_data |> 
  slice(88) |> 
  select(2:184)

rownames <- ncbi_data |> 
  slice(89:24615) |> 
  select(1) |> 
  pull()

ncbi_norm_exp <- ncbi_norm_exp |> 
  mutate(Probe_IDs = rownames) |> 
  relocate(Probe_IDs)

```

```{r}

```
