### Source functions

```{r}
source("../R/99_proj_func.R")
```

### Library:

```{r}
#| message: false
library("tidyverse")
library("ggridges")
library("viridis")
library("broom")
library("ggrepel")
library("corrplot")
library("plyr")
```

### loading:

```{r}
#| eval: true
#| message: false

ncbi_joined <- vroom::vroom("../data/04_ncbi_joined.tsv.gz",
                             delim = "\t")

placenta_joined <- vroom::vroom("../data/04_placenta_joined.tsv.gz",
                                delim = "\t")

maternal_joined <- vroom::vroom("../data/04_maternal_joined.tsv.gz",
                                delim = "\t")

cord_joined <- vroom::vroom("../data/04_cord_joined.tsv.gz",
                                delim = "\t")

smoking_fc_cord <- vroom::vroom("../data/04_smoking_fc_cord.tsv.gz",
                                 delim = "\t")

ncbi_joined |> 
  sample_n(5)
placenta_joined |> 
  sample_n(5)
```

### Fitting model to all sample types:

```{r}
regression_placenta <- create_models(placenta_joined)

regression_cord <- create_models(cord_joined)

regression_maternal <- create_models(maternal_joined)

```

### Volcano plot:

```{r}
#| warning: false

significant_placenta <- subset(regression_placenta , 
                          is_significant == "yes") |>
  dplyr::select(gene)

significant_cord <- subset(regression_cord , 
                          is_significant == "yes") |>
  dplyr::select(gene)

significant_maternal <- subset(regression_maternal , 
                          is_significant == "yes") |>
  dplyr::select(gene)

regression_placenta <- regression_placenta |>
  mutate(sample = "placenta")

regression_maternal <- regression_maternal |>
  mutate(sample = "maternal")

regression_cord <- regression_cord |>
  mutate(sample = "cord")

regression_all <- join_all(list(regression_placenta,
                                regression_maternal,
                                regression_cord),
                           type='full')

```

```{r}
regression_all |>
  ggplot(aes(x = gene,
             y = -log(p.value,10),
             label = ifelse(is_significant == "yes", 
                            gene, 
                            ""))) + 
  geom_point(aes(x = estimate, 
                 color = is_significant),
             alpha = .3,
             size = .2) +
  geom_hline(yintercept = 0) +
  theme_minimal(base_size = 10) +
  scale_x_continuous(limits=c(-.4,.4)) + 
  scale_y_continuous(limits=c(0,3.5)) + 
  labs(title = "Genes Associated with",
       subtitle = "Genes highlighted in turquoise were significant at a level of signifcance of p < .05",
       x = "Estimates",
       y = "-log10(p)") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .95),
        plot.subtitle = element_text(hjust = .95)) +
  facet_grid(~sample,
             labeller = as_labeller(c(placenta = "Samples obtained from placenta", 
                                      maternal = "Samples obtained from maternal blood",
                                      cord = "Samples obtained from cord blood")))

```

```{r}

# didn't correct anything after this (Masha)

aug_norm_exprs_04 |>
  ggplot(aes(x = gene,
             y = -log(p.value,10),
             label = ifelse(is_significant == "yes", 
                            gene, 
                            ""))) + 
  geom_point(aes(x = estimate, 
                 color = is_significant),
             alpha = .5,
             size=1) +
  geom_hline(yintercept = 0) +
  theme_minimal(base_size = 10) +
  labs(title = "Genes Associated with",
       subtitle = "Genes highlighted in turquoise were significant after multiple testing correction",
       x = "Estimates",
       y = "-log10(p)") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .95),
        plot.subtitle = element_text(hjust = .95)) 
```

## Expression level based on smoking status of mother:

```{r}

# Don't think this plot says anything, should be dropped(Masha)

ncbi_joined |> 
  select(-names(ncbi_joined)[1:2],
         -names(ncbi_joined)[4:15]) |>
  pivot_longer(cols = -c(smoking_status,
                         individual),
               names_to = "gene",
               values_to = "expr_level") |>
  #sample_n(20) |>
  ggplot(aes(expr_level, 
             fill = smoking_status)) +
  geom_boxplot()
```

### Gene association plot:

```{r}
# we should make this readable
aug_norm_exprs_04 |>
  filter(is_significant == "yes") |>
  ggplot(aes(y = fct_reorder(gene,
                             estimate))) + 
  geom_point(aes(x = estimate), 
             size = 1.5) +
  geom_errorbarh(aes(xmax = conf.high,
                     xmin = conf.low),
                     height = 1) +
  geom_vline(xintercept = 0) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Genes Associated with Smoking",
       x = "Estimates (95%CIs)",
       y = "",)
```

We can generally see that when a person smokes there is a major downregulation of some genes. Some are also upregulated. We cant tell the effect of the regulation

```{r}
num_genes_to_compare <- 6
genes_start_idx = 16

ncbi_joined |>
  select(smoking_status,
         genes_start_idx : (genes_start_idx + num_genes_to_compare)) |> 
  pivot_longer(names_to = "variable",
               values_to = "values",
               3:last_col()) |> 
  ggplot(aes(JMJD1A,
             values)) + 
  geom_point(aes(color = smoking_status)) + 
  facet_grid(. ~ variable,
             scales = "free_x") + 
  geom_smooth(method = "lm",
              se = FALSE) + 
  scale_y_continuous(trans = "log2") + 
  scale_x_continuous(trans = "log2") +
  labs(x="Gene expression of JMJD1A",
       y="Gene expression",
       title = "Gene expression of 6 genes plotted against the gene expression of gene JMJD1A")
```

### Gene expression correlation

```{r}

genes_exp_selection <- ncbi_joined |> 
  select(20:28)

corrplot(cor(genes_exp_selection),
  type = "upper"
)
```

### Log Fold Change

```{r}
# this has been done. df names are:

smoking_fc_all
smoking_fc_placenta
smoking_fc_maternal
smoking_fc_cord

######

ncbi_smoking_logfc_cord

ncbi_smoking_logfc_cord |>
  arrange(desc(abs(log_fold_change))) |> 
  slice_head(n=30) |> 
  ggplot(aes(x=Gene, y=log_fold_change)) +
    geom_bar(stat="identity") + 
    coord_flip() +
  labs(
    title = "Log fold change of 30 genes most affected by smoking",
    y = "Log fold change")
```

### PCR

```{r}
genes_large_fold_change <- smoking_fc_cord |>
  arrange(desc(abs(log_fold_change))) |> 
  slice_head(n=170) |> 
  pull(Gene)

gene_exp_cord <- get_gene_expr_by_sample(ncbi_joined, "cord blood", c("smoking_status"))

PCA <- gene_exp_cord |> 
  select(genes_large_fold_change) |> 
  prcomp() 

# summary(PCA)

pca_data <- PCA$x |> 
  as.data.frame() |> 
  mutate(smoking_status = gene_exp_cord$smoking_status)

ggplot(pca_data, aes(PC1, PC2)) +
      geom_point(aes(colour = smoking_status)) +
  labs(title="PCA plot")
```

```{r}
# Heatmap very much draft
ncbi_joined |>
  filter(smoking_status == "smoker") |>
  select(-colnames(ncbi_joined)[1:15]) %>%
  pivot_longer(col = -colnames(.)[1],
               names_to = "gene",
               values_to = "expr_level") |>
  ggplot(aes(x = as.factor(individual),
             y = gene,
             fill = expr_level)) + 
    geom_tile() +
    theme(legend.position="none")

```
