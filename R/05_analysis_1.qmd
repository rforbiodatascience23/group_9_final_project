### Library:

```{r}
#| message: false
library("tidyverse")
library("ggridges")
library("viridis")
library("broom")
library("ggrepel")
```

### loading:

```{r}
#| eval: false
#| message: false
source("../R/99_proj_func.R")

pheno_data <- vroom::vroom("../data/02_ncbi_clean_pheno.tsv.gz", delim = "\t")
expr_data <- vroom::vroom("../data/02_ncbi_clean_expr.tsv.gz", delim = "\t")

pheno_data |> sample_n(5)

transposed_expr_data <- expr_data |> pivot_longer(cols= -1) |> pivot_wider(names_from = "Gene",values_from = "value") |>
rename("id"=name)

transposed_expr_data |> sample_n(5)
```

### joining:

```{r}

# Joining
joined_tables <- pheno_data |>
  full_join(transposed_expr_data)
```

### plotting:

```{r}
clean_pheno_data |>
  ggplot(aes(y = `Mother_age_years`,
             fill=smoking_status)) +
  geom_boxplot() +
  labs(y = "Mother age (years)",
       x= "",
       caption = "Data from NCBI (2011)",
       title = "Comparison of mother's age by smoking status",
       fill = "Smoking status") +
  theme(legend.position = "bottom")

clean_pheno_data |>
  ggplot(aes(y = maternal_bmi,
             fill=smoking_status)) +
  geom_boxplot() +
  labs(x = "",
       y= "Maternal BMI",
       caption = "Data from NCBI (2011)",
       title = "Comparison of mother's BMI by smoking status",
       fill = "Smoking status") +
  theme(legend.position = "bottom")


clean_pheno_data |>
  ggplot(aes(y = `maternal_blood_cotinine_ng_ml`,
             fill=smoking_status)) +
  geom_boxplot() +
  labs(x = "",
       y= "Blood cotinine (ng/ml)",
       caption = "Data from NCBI (2011)",
       title = "Comparison of mother's blood cotinine concentration by smoking status",
       fill = "Smoking status") +
  theme(legend.position = "bottom")

clean_pheno_data |>
  ggplot(aes(`cord_blood_cotinine_ng_ml`,
             fill=smoking_status)) +
  geom_boxplot() +
  labs(x = "",
       y= "Cord blood cotinine (ng/ml)",
       caption = "Data from NCBI (2011)",
       title = "Comparison of mother's blood cotinine concentration by smoking status",
       fill = "Smoking status") +
  theme(legend.position = "bottom")

# Plot of a single genes exprs by non- and smokers
joined_tables |>
  sample_n(20) |>
  ggplot(aes(fill=smoking_status)) +
  geom_boxplot(aes(ENSG00000233927)) +
  labs(x = "",
       y= "",
       caption = "Data from NCBI (2011)",
       title = "",
       fill = "Smoking status") +
  theme(legend.position = "bottom")
```

### Data statistics:

```{r}

joined_colnames <- joined_tables |> 
  colnames()

auged_norm_exprs_00 <- joined_tables |> 
  dplyr::select(-joined_colnames[1:7],-
           joined_colnames[9:12]) |>
  mutate(is_smoker = case_when(str_detect(smoking_status, 
                                          "non") == 1 ~ 0,
                               str_detect(smoking_status, 
                                          "non") == 0 ~ 1), 
         .before = 1) |>
  dplyr::select(-smoking_status)

auged_norm_exprs_01 <- auged_norm_exprs_00 |>
  pivot_longer(cols = starts_with("EN"),
               names_to = "gene",
               values_to = "expr_level") |>
  mutate(log_2_expr_level =log2(expr_level)) |>
  dplyr::select(-expr_level)

auged_norm_exprs_02 <- auged_norm_exprs_01 |>
  group_by(gene) |>
  nest() |>
  ungroup()

# updating data frame. First we group rows by gene, and then we add a variable containing model fitted to expression level against early_metastasis variable
auged_norm_exprs_03 <- auged_norm_exprs_02 |>
  group_by(gene) |>
  mutate(model_object = map(.x = data,
                            .f = ~lm(formula = log_2_expr_level ~ is_smoker,
                                     data = .x))) |>
  
# using tidy function to turn model summary into a tibble instead of a list  
  mutate(model_object_tidy = map(.x = model_object,
                                 .f = ~ tidy(.x,
                                             conf.int = TRUE,
                                             conf.level = 0.95)))

# unnesting the tidy models, filtering to only get "slope"-coefficients for models and selecting desired variables
auged_norm_exprs_04 <- auged_norm_exprs_03 |>
  unnest(model_object_tidy) |>
  filter(term == "is_smoker") |>
  dplyr::select(gene, 
                p.value, 
                estimate, 
                conf.low, 
                conf.high) |>
  ungroup() |>
  
# creating variables "q-value" which is the p-value adjusted for multiple comparisons and "is_significant" which indicates whether observations are statistically significant when using a level of significance of 0.0
  mutate(is_significant = case_when(
           p.value < 0.05 ~ "yes",
           0.05 < p.value ~ "no"
         ))
```

### Volcano plot:

```{r}
significant_labels <- subset(auged_norm_exprs_04 , 
                          is_significant == "yes") |>
  dplyr::select(gene)

auged_norm_exprs_04 |>
  ggplot(aes(x = gene,
             y = -log(p.value,10),
             label = ifelse(is_significant == "yes", 
                            gene, 
                            ""))) + 
  geom_point(aes(x = estimate, 
                 color = is_significant),
             alpha = .5,
             size=1) +
  geom_hline(yintercept = 0) +
  theme_minimal(base_size = 10) +
  labs(title = "Genes Associated with",
       subtitle = "Genes highlighted in turquoise were significant after multiple testing correction",
       x = "Estimates",
       y = "-log10(p)") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .95),
        plot.subtitle = element_text(hjust = .95))
```

## more rangling:

```{r}

# General exprs of all genes comparing smoking

joined_tables |> select(-joined_colnames[1:7],
                        -joined_colnames[9:12]) |>
  pivot_longer(cols = starts_with("EN"),
               names_to = "gene",
               values_to = "expr_level") |>
  sample_n(20) |>
  ggplot(aes(expr_level, 
             fill = smoking_status)) +
  geom_boxplot()
```

### Gene association plot:

```{r}

auged_norm_exprs_04 |>
  filter(is_significant == "yes") |>
  ggplot(aes(y = fct_reorder(gene,estimate))) + 
  geom_point(aes(x = estimate), 
             size=1.5) +
  geom_errorbarh(aes(xmax = conf.high,
                     xmin = conf.low),
                     height = 1) +
  geom_vline(xintercept = 0) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom") +
  labs(title = "Genes Associated with Smoking",
       x = "Estimates (95%CIs)",
       y = "",)
```

We can generrely see that when a person smokes there is a major downregulation of some genes. Some are also upregulated. We cant tell the effect of the regulation
